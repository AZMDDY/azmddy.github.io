(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{369:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"函数调用栈"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#函数调用栈"}},[s._v("#")]),s._v(" 函数调用栈")]),s._v(" "),t("blockquote",[t("p",[s._v("在程序运行过程中，栈用于维护函数调用的上下文，离开了栈，函数调用就无法实现。")])]),s._v(" "),t("h2",{attrs:{id:"栈帧"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#栈帧"}},[s._v("#")]),s._v(" 栈帧")]),s._v(" "),t("p",[s._v("每个函数发生调用时，都会有一块栈空间，这块栈空间称为"),t("code",[s._v("栈帧")]),s._v("。")]),s._v(" "),t("p",[s._v("栈帧的结构如下：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AZMDDY/imgs/img/image-20220226161830034.png",alt:"image-20220226161830034"}})]),s._v(" "),t("p",[s._v("这里要注意的是："),t("strong",[s._v("栈空间是从高地址到低地址分配的")]),s._v("。")]),s._v(" "),t("p",[t("code",[s._v("rbp")]),s._v("：基址指针寄存器(reextended base pointer)，其内存放着一个指针，该指针永远指向系统栈最上面一个栈帧的底部。")]),s._v(" "),t("p",[t("code",[s._v("rsp")]),s._v("：栈指针寄存器，其内存放着一个指针，该指针永远指向系统栈最上面一个栈帧的栈顶。")]),s._v(" "),t("p",[s._v("栈帧保存了一个函数调用所需要的维护信息：")]),s._v(" "),t("ul",[t("li",[s._v("函数的返回地址和参数。")]),s._v(" "),t("li",[s._v("临时变量：包括函数的非静态局部变量以及编译器自动生成的其他临时变量。")]),s._v(" "),t("li",[s._v("保存的上下文：包括在函数调用前后需要保持不变的寄存器。")])]),s._v(" "),t("h2",{attrs:{id:"函数调用与函数调用栈"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#函数调用与函数调用栈"}},[s._v("#")]),s._v(" 函数调用与函数调用栈")]),s._v(" "),t("p",[s._v("写一个程序，通过反汇编，了解真实的函数调用栈。")]),s._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// demo.cpp")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<cstdint>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Func2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Func1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" d "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Func2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" d "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Func2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" b "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" b "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("101")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int32_t")]),s._v(" c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Func1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br")])]),t("ol",[t("li",[t("code",[s._v("g++ -g demo.cpp -o demo")]),s._v(":编译得到可执行文件。")]),s._v(" "),t("li",[t("code",[s._v("objdump -s -d demo")]),s._v(":反汇编得到汇编代码。")])]),s._v(" "),t("p",[s._v("函数调用过程如下：")]),s._v(" "),t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AZMDDY/imgs/img/image-20220226165700995.png",alt:"image-20220226165700995"}}),s._v(" "),t("p",[s._v("总结一下，当函数 A 调用函数 B 时：")]),s._v(" "),t("ol",[t("li",[s._v("将函数入参保存要寄存器中。（在函数 A 的调用栈中）")]),s._v(" "),t("li",[s._v("将函数 B 的返回地址压入栈，即将"),t("code",[s._v("callq <B>")]),s._v("的下一行指令地址压入栈，然后调用函数 B。（在函数 A 的调用栈中）")]),s._v(" "),t("li",[s._v("函数参数入栈。（在函数 B 的调用栈中）")]),s._v(" "),t("li",[s._v("局部变量入栈。（在函数 B 的调用栈中）")]),s._v(" "),t("li",[s._v("执行一些运算指令。（在函数 B 的调用栈中）")]),s._v(" "),t("li",[s._v("将返回结果保存到寄存器"),t("code",[s._v("eax")]),s._v("中。（在函数 B 的调用栈中）")]),s._v(" "),t("li",[s._v("从寄存器"),t("code",[s._v("eax")]),s._v("中获得函数 B 的返回值。（在函数 A 的调用栈中）")])]),s._v(" "),t("p",[s._v("其实函数调用过程中涉及到栈基指针"),t("code",[s._v("rbp")]),s._v("和栈顶指针"),t("code",[s._v("rsp")]),s._v("的变化。也就是这段汇编：")]),s._v(" "),t("div",{staticClass:"language-assembly line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("push %rbp\nmov  %rsp,%rbp\nsub  $0x20,%rsp\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("它的作用就是把上一个栈帧的"),t("code",[s._v("rbp")]),s._v("存起来，将当前栈的"),t("code",[s._v("rbp")]),s._v("更新成上一个栈帧的"),t("code",[s._v("rsp")]),s._v("，然后设置当前栈的"),t("code",[s._v("rsp")])]),s._v(" "),t("p",[s._v("。这样就完成了两个指针维护一个栈帧大小的功能。函数调用就是这两个指针的移动，函数调用栈的扩张和收缩。")]),s._v(" "),t("h2",{attrs:{id:"实际函数调用栈的阅读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实际函数调用栈的阅读"}},[s._v("#")]),s._v(" 实际函数调用栈的阅读")]),s._v(" "),t("p",[s._v("首先明确一点，栈空间是从高地址到低地址扩张的，阅读也是从高地址开始读。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AZMDDY/imgs/img/image-20220226173501291.png",alt:"image-20220226173501291"}})]),s._v(" "),t("h2",{attrs:{id:"查看调用栈"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看调用栈"}},[s._v("#")]),s._v(" 查看调用栈")]),s._v(" "),t("p",[s._v("首先需要有调试信息的二进制文件。")]),s._v(" "),t("p",[s._v("利用"),t("code",[s._v("gdb")]),s._v("查看。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("gdb demo\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" b Func1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("int, int"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 打个断点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" r\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" s\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" disassemble "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看当前函数的汇编，能看到具体执行到哪一条指令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" ni "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行一条指令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" p "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$rbp")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" p "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$rsp")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" x/32xg "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$rbp")]),s._v(" - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看从$rbp - 128的地址开始32的单位（以16进制显示，每个单元8字节）的内存内容")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);